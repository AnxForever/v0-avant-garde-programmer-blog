name: Deploy to Aliyun

on:
  push:
    branches:
      - main
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to Aliyun Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.ALIYUN_HOST }}
          username: ${{ secrets.ALIYUN_USERNAME }}
          password: ${{ secrets.ALIYUN_PASSWORD }}
          port: 22
          command_timeout: 10m
          script: |
            echo "ğŸš€ å¼€å§‹éƒ¨ç½²..."

            # è¿›å…¥é¡¹ç›®ç›®å½•
            cd ${{ secrets.ALIYUN_PROJECT_PATH }}

            # æ¸…ç†å¯èƒ½çš„å†²çªæ–‡ä»¶
            echo "ğŸ§¹ æ¸…ç†å†²çªæ–‡ä»¶..."
            rm -f package-lock.json
            git checkout -- .

            # æ‹‰å–æœ€æ–°ä»£ç 
            echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
            git pull origin main

            # å®‰è£…ä¾èµ–
            echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
            npm install

            # æ„å»ºé¡¹ç›®
            echo "ğŸ”¨ æ„å»ºé¡¹ç›®..."
            npm run build

            # é‡å¯ PM2 æœåŠ¡
            echo "ğŸ”„ é‡å¯æœåŠ¡..."
            pm2 restart blog || pm2 start npm --name "blog" -- start

            echo "âœ… éƒ¨ç½²å®Œæˆï¼"
            git log -1 --oneline

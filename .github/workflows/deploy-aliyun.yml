name: Deploy to Aliyun

on:
  push:
    branches:
      - main
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to Aliyun Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.ALIYUN_HOST }}
          username: ${{ secrets.ALIYUN_USERNAME }}
          password: ${{ secrets.ALIYUN_PASSWORD }}
          port: 22
          command_timeout: 15m
          script: |
            set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

            echo "ğŸš€ å¼€å§‹éƒ¨ç½²..."
            echo "ğŸ“… æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"

            # è¿›å…¥é¡¹ç›®ç›®å½•
            cd ${{ secrets.ALIYUN_PROJECT_PATH }}

            # æ˜¾ç¤ºå½“å‰ç‰ˆæœ¬
            echo "ğŸ“Œ å½“å‰ç‰ˆæœ¬:"
            git log -1 --oneline

            # æ¸…ç†å¯èƒ½çš„å†²çªæ–‡ä»¶
            echo "ğŸ§¹ æ¸…ç†å·¥ä½œåŒº..."
            git checkout -- .
            rm -f package-lock.json

            # æ‹‰å–æœ€æ–°ä»£ç ï¼ˆå¸¦é‡è¯•æœºåˆ¶ï¼Œæœ€å¤š 5 æ¬¡ï¼‰
            echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
            MAX_RETRIES=5
            RETRY_COUNT=0
            FETCH_SUCCESS=false

            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              RETRY_COUNT=$((RETRY_COUNT + 1))
              echo "   å°è¯• $RETRY_COUNT/$MAX_RETRIES..."

              if git fetch origin main --depth=1 2>/dev/null; then
                FETCH_SUCCESS=true
                break
              fi

              echo "   âš ï¸ ç½‘ç»œè¶…æ—¶ï¼Œ${RETRY_COUNT}s åé‡è¯•..."
              sleep $RETRY_COUNT
            done

            if [ "$FETCH_SUCCESS" = false ]; then
              echo "âŒ æ— æ³•è¿æ¥ GitHubï¼Œéƒ¨ç½²å¤±è´¥"
              exit 1
            fi

            # å¼ºåˆ¶åŒæ­¥åˆ°æœ€æ–°ç‰ˆæœ¬
            git reset --hard origin/main

            echo "ğŸ“Œ æ›´æ–°åç‰ˆæœ¬:"
            git log -1 --oneline

            # å®‰è£…ä¾èµ–
            echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
            npm install --prefer-offline

            # æ„å»ºé¡¹ç›®
            echo "ğŸ”¨ æ„å»ºé¡¹ç›®..."
            npm run build

            # é‡å¯ PM2 æœåŠ¡
            echo "ğŸ”„ é‡å¯æœåŠ¡..."
            pm2 restart blog || pm2 start npm --name "blog" -- start

            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            sleep 3

            # æ£€æŸ¥æœåŠ¡çŠ¶æ€
            echo "ğŸ“Š æœåŠ¡çŠ¶æ€:"
            pm2 status blog

            echo ""
            echo "âœ… éƒ¨ç½²å®Œæˆï¼"
            echo "ğŸ“… å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
